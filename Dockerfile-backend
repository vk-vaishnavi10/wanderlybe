# ===============================
# ðŸ§± Stage 1 â€” Clone + Build the Spring Boot JAR
# ===============================
FROM maven:3.9.5-eclipse-temurin-21 AS build
WORKDIR /app

# âœ… Install git
RUN apt-get update && apt-get install -y git

# âœ… Use the correct Java home from Temurin Maven image
ENV JAVA_HOME=/opt/java/openjdk
ENV PATH="$JAVA_HOME/bin:$PATH"

# âœ… Clone your backend repo
RUN git clone --branch main https://github.com/vk-vaishnavi10/wanderlybe.git .

# âœ… Verify Java and Maven versions (optional sanity check)
RUN java -version && mvn -v

# âœ… Download all dependencies (for caching)
RUN mvn dependency:go-offline -B

# âœ… Build the Spring Boot JAR (skip tests)
RUN mvn clean package -DskipTests

# ===============================
# ðŸš€ Stage 2 â€” Run the Spring Boot app
# ===============================
FROM eclipse-temurin:21-jdk
WORKDIR /app

# âœ… Copy built JAR from previous stage
COPY --from=build /app/target/*.jar app.jar

# âœ… Create upload directory (for image uploads, etc.)
RUN mkdir -p /app/uploads/profile

# âœ… Mount uploads as volume (to persist data)
VOLUME ["/app/uploads"]

# âœ… Expose backend port
EXPOSE 8085

# âœ… Run Spring Boot JAR
ENTRYPOINT ["java", "-jar", "app.jar"]
